#!/bin/bash
#
# upload - upload files to the web

source=$1

if [[ ! $source || $source == - ]]; then
    source=$(mktemp) || exit 1
    trap 'rm -f -- "$source"' exit
    cat > "$source"
    printf -v basename 'stdin-%(%F-%T)T.txt' -1
else
    source=$(realpath "$source")
    [[ -r $source ]] || exit 1
    basename=${source##*/}
fi

destination=${2:-$basename}

host=up.v3lo.pw
url=$(jq -nr --arg host "$host" --arg destination "$destination" '"https://\($host)/\($destination | @uri )"')

if [[ $source == ~/sync/*/* ]]; then
    base=${source#~/sync/}
    ssh "$host" bash -s "${base@Q}" "${destination@Q}" <<< 'install -m 644 sync/"$1" sync/uploads/"$2"'
else
    rsync -s --chmod=F644 "$source" "$host:sync/uploads/$destination"
fi

printf '%s\n' "$url" | tee >(clip)

if [[ $(dunstify -t 10000 -A open,open -i network-server "uploaded $basename" "to $url") == open ]]; then
    exec xdg-open "$url"
fi &
